name: Deploy Test
concurrency: 'Deploy Test'

on:
  push:
    branches:
      - release

  workflow_dispatch:

  # Global environment variables
env:
    CONTAINER_NAME: churchmanager-api
    REPOSITORY: churchmanager-api

jobs:
  build:
    name: Deploy to Jelastic
    runs-on: ubuntu-latest

    steps:
        - name: üõí Checkout
          uses: actions/checkout@v2

        - name: ‚öôÔ∏è Set env to Test
          if: endsWith(github.ref, '/develop') ||  endsWith(github.ref, '/release')
          run: |
            echo "ENVIRONMENT=Test" >> $GITHUB_ENV

        - name: ‚öôÔ∏è Set env to Production
          if: endsWith(github.ref, '/master')
          run: |
            echo "ENVIRONMENT=Test" >> $GITHUB_ENV          

        - name: ‚öôÔ∏è Set current date
          id: date
          run: echo "::set-output name=date::$(date +'%Y%m%d')"

        - name: üõ†Ô∏è Update BuildInfo version
          id: build-info
          env:
              VERSION: ${{ steps.date.outputs.date }}-${{ github.run_number }}-${{ env.ENVIRONMENT }}
          run: |
              printf '{"version":"%s"}' $VERSION > ./buildinfo.json
              cat ./buildinfo.json # just some logging
          working-directory: ./src/ChurchManager.Api/ChurchManager.Api
                    
        - name: üõ†Ô∏è Login to Docker Hub
          uses: docker/login-action@v1
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_PASSWORD }}

        - name: üõ†Ô∏è Build, tag, and push image to Amazon ECR
          id: build-image
          env:
            REGISTRY: godcode
            REPOSITORY: ${{ env.REPOSITORY }}
            IMAGE_TAG: ${{ steps.date.outputs.date }}-${{ github.run_number }}
          run: |
            # Build & push a docker container to ECR.
            docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG .
            docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG
            echo "::set-output name=image::$REGISTRY/$REPOSITORY:$IMAGE_TAG"
            echo "::set-output name=tag::$IMAGE_TAG"

        - name:  ‚è≠ Deploy to Jelastic
          uses: fjogeleit/http-request-action@master
          with:
            url: https://app.paas.mamazala.com/1.0/environment/control/rest/redeploycontainers?envName=docker&session=2390be464b054389842b82aa0a9d4b8ab9914208&tag=${{ steps.build-image.outputs.tag }}&nodeGroup=cp
            method: 'POST'
            timeout: 240000